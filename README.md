
# Python logging library to emit JSON logs in a SAP CloudFoundry environment.

This is a collection of support libraries for Python applications running on Cloud Foundry that serve two main purposes: provide (a) means to emit structured application log messages and (b) instrument web applications of your application stack to collect request metrics.

For details on the concepts and log formats, please look at the sibling project for [java logging support](https://github.com/SAP/cf-java-logging-support).


## 1. Features
1. Lightweight, no dependencies. Support Python 2.7 & 3.5.
2. Compatible with Python **logging** module. Minimal configuration needed.
3. Emit JSON logs ([format details](https://github.com/SAP/cf-java-logging-support/tree/master/cf-java-logging-support-core/beats)).
4. Support **correlation-id**.
5. Support request instrumentation. Built in support for [Flask 0.1x](http://flask.pocoo.org/) & [Sanic 0.5.x](https://github.com/channelcat/sanic). Extensible to support others.
6. Include CF-specific information (space id, app id, etc.) to logs.
7. Support adding extra properties to JSON log object.

## 2 Installation

Install the package with pip:

```
pip install -e cf-python-logging-support git+https://github.com/SAP/cf-python-logging-support.git
```

## 3 Usage
### 3.1 Quick start

#### 3.1.1 Setting up your application

Logging library needs to be initialized. Depending on you application type, different initialization is used. You should usually do this in your application entrypoint.

For CLI applications you just need to call `cf_logging.init()` *once* to configure the library. The library will try to configure future loggers to emit logs in JSON format.

If you are using one of the supported frameworks, check the [Configuration](#configuration) section to see how to configure it.

##### Setting up the CloudFoundry environment

In order for your logs to appear on Kibana dashboard, you have to create an **application-logs** service instance and bind it to your application.


-----
# Python Logging Support for Cloud Foundry


## Description
This is logging library that generates JSON logs suitable with SAP Cloud Foundry's log format

### Download and Installation
Install the the cf-python-logging-support package with:
```bash
pip install -e cf-python-logging-support git+https://github.com/SAP/cf-python-logging-support.git
```

### Overview
The logging library allows the application to write JSON formatted logs to the standard output.

The library is ment to be used with the following:
  - Sanic
  - Flask
  - General application

It will configure Python's logging libraries to use our formatters and produce JSON log messages.

When the library is used within Sanic and Flask it provides more detailed output, related to the processing time of the requests.

When used in a general application the log message will contain application specific information based on the Cloud Foundry's application environment.

### Configuration
After installation follow the following guide to configure the Python cf logging library.
#### Flask

First import the `cf_logging` library and setup Flask logging on the application.
```python
from cf_logging import flask_logging
app = flask.Flask(__name__)
flask_logging.init(app, logging.INFO)
```
Next use  Python's logging library
```
@app.route('/')
def root_route():
    logger = logging.getLogger('my.logger')
    logger.info('Hi')

    return 'ok'
```
Note the logs generated by the application

#### Sanic
```python
import sanic
import logging
from cf_logging import sanic_logging
from sanic.response import HTTPResponse
from cf_logging.core.constants import REQUEST_KEY,


app = sanic.Sanic('test.cf_logging')
sanic_logging.init(app)

@app.route('/')
async def two(request):
    extra = {REQUEST_KEY: request}
    logging.getLogger('my.logger').debug('Hi', extra = extra)
    return HTTPResponse(body='ok')
```
__Note__: With Sanic you need to pass the request with an `extra` parameter in the logging API. This is needed in order to get the correlation_id generated at the beginning of the request or fetched from the HTTP headers.

#### General
```python
import cf_logging
import logging

cf_logging.init()

logger = logging.getLogger("cli.logger")
logger.info('hi')
```

__Notes__:
- All loggers setup and created before the initialization of the CF logging library will be left untouched.
- When using Flask and Sanic with the logging library we attach a before and after request middleware that will capture response times for each request

### Examples
For more examples please see the tests within the `./tests/` directory.

## Requirements
No external requirements are need to run the package.

## Limitations
NA

## Known Issues
NA

## How to obtain support
Please open an issue on the github page.

## Contributing
Please create a pull request and briefly describe the nature of the change.
Please submit a test case along with your pull request.

## To-Do (upcoming changes)
NA

## License
Copyright (c) 2017 SAP SE or an SAP affiliate company. All rights reserved.
This file is licensed under the Apache Software License, v. 2 except as noted otherwise in the [LICENSE file](LICENSE).

